<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>美化应用最终测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }

      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .test-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .test-section h3 {
        margin-top: 0;
        color: #333;
      }

      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #0056b3;
      }

      .demo-area {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 600px;
        background: #f0f0f0;
        border-radius: 8px;
        margin: 20px 0;
      }

      .test-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .test-result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>🎨 美化应用最终功能测试</h1>

      <div class="test-section">
        <h3>🎯 测试目标</h3>
        <p>验证以下功能是否正确实现：</p>
        <ul>
          <li>✅ QQ和聊天背景页面不显示模式切换按钮</li>
          <li>✅ 美化主题界面改为边框颜色和图标颜色选择</li>
          <li>✅ 删除原有的主题选择系统</li>
          <li>✅ 添加用户自定义颜色功能</li>
          <li>✅ 保留手机壁纸界面的完整功能</li>
          <li>🆕 页面美化：改进界面布局和视觉效果</li>
          <li>🆕 修复自动跳转：防止点击后页面滚动到顶部</li>
          <li>🆕 修复图标颜色：确保信号电量图标正确应用颜色</li>
          <li>🆕 集成导入导出：主题配置与壁纸一起导入导出</li>
        </ul>
      </div>

      <div class="test-section">
        <h3>🎮 测试控制</h3>
        <div class="test-controls">
          <button onclick="testPhoneWallpaperMode()">测试手机壁纸模式</button>
          <button onclick="testPhoneThemeMode()">测试手机主题模式</button>
          <button onclick="testQQHomeMode()">测试QQ主页模式</button>
          <button onclick="testQQChatMode()">测试QQ聊天模式</button>
          <button onclick="testColorSelection()">测试颜色选择</button>
          <button onclick="testCustomColors()">测试自定义颜色</button>
          <button onclick="testScrollPosition()">测试滚动位置保持</button>
          <button onclick="testIconColorFix()">测试图标颜色修复</button>
          <button onclick="testImportExport()">测试导入导出功能</button>
          <button onclick="runAllTests()">🔄 运行全部测试</button>
        </div>
      </div>

      <div class="test-section">
        <h3>📊 测试结果</h3>
        <div id="testResults" class="test-result">等待测试开始...</div>
      </div>

      <div class="test-section">
        <h3>📱 美化应用演示</h3>
        <div class="demo-area" id="demoArea">
          <!-- 美化应用界面将在这里显示 -->
        </div>
      </div>
    </div>

    <!-- 加载必要的文件 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles/phone-shell.css" />
    <link rel="stylesheet" href="styles/phone-interface.css" />
    <link rel="stylesheet" href="styles/wallpaper-app.css" />
    <script src="apps/phone-shell.js"></script>
    <script src="apps/phone-interface.js"></script>
    <script src="apps/wallpaper-app.js"></script>

    <script>
      let testResults = [];

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        testResults.push({ message: logEntry, type });
        updateTestResults();
        console.log(message);
      }

      function updateTestResults() {
        const resultsDiv = document.getElementById('testResults');
        resultsDiv.innerHTML = testResults
          .map(
            result =>
              `<div style="color: ${result.type === 'error' ? 'red' : result.type === 'success' ? 'green' : 'black'}">${
                result.message
              }</div>`,
          )
          .join('');
        resultsDiv.scrollTop = resultsDiv.scrollHeight;
      }

      function clearResults() {
        testResults = [];
        updateTestResults();
      }

      // 测试手机壁纸模式
      function testPhoneWallpaperMode() {
        log('🔄 测试手机壁纸模式...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('wallpaper');
          window.WallpaperApp.show();

          setTimeout(() => {
            const modeSwitcher = $('.wallpaper-mode-switcher');
            const wallpaperContent = $('.wallpaper-preview-section');

            if (modeSwitcher.length > 0 && wallpaperContent.length > 0) {
              log('✅ 手机壁纸模式：模式切换按钮和壁纸内容正确显示', 'success');
            } else {
              log('❌ 手机壁纸模式：界面元素缺失', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试手机主题模式
      function testPhoneThemeMode() {
        log('🔄 测试手机主题模式...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('theme');
          window.WallpaperApp.show();

          setTimeout(() => {
            const borderColorSection = $('.border-color-section');
            const iconColorSection = $('.icon-color-section');
            const customColorInputs = $('input[type="color"]');
            const oldThemeButtons = $('.theme-option-btn');

            if (
              borderColorSection.length > 0 &&
              iconColorSection.length > 0 &&
              customColorInputs.length >= 2 &&
              oldThemeButtons.length === 0
            ) {
              log('✅ 手机主题模式：新颜色选择界面正确显示，旧主题按钮已删除', 'success');
            } else {
              log('❌ 手机主题模式：界面更新不完整', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试QQ主页模式
      function testQQHomeMode() {
        log('🔄 测试QQ主页模式...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('qq-home');
          window.WallpaperApp.show();

          setTimeout(() => {
            const modeSwitcher = $('.wallpaper-mode-switcher');
            const wallpaperContent = $('.wallpaper-preview-section');

            if (modeSwitcher.length === 0 && wallpaperContent.length > 0) {
              log('✅ QQ主页模式：模式切换按钮已隐藏，壁纸功能保留', 'success');
            } else {
              log('❌ QQ主页模式：模式切换按钮仍然显示或壁纸功能缺失', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试QQ聊天模式
      function testQQChatMode() {
        log('🔄 测试QQ聊天模式...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('qq-chat');
          window.WallpaperApp.show();

          setTimeout(() => {
            const modeSwitcher = $('.wallpaper-mode-switcher');
            const wallpaperContent = $('.wallpaper-preview-section');

            if (modeSwitcher.length === 0 && wallpaperContent.length > 0) {
              log('✅ QQ聊天模式：模式切换按钮已隐藏，壁纸功能保留', 'success');
            } else {
              log('❌ QQ聊天模式：模式切换按钮仍然显示或壁纸功能缺失', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试颜色选择功能
      function testColorSelection() {
        log('🔄 测试颜色选择功能...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('theme');
          window.WallpaperApp.show();

          setTimeout(() => {
            const colorOptions = $('.color-option');
            const borderColors = $('.border-color-section .color-option');
            const iconColors = $('.icon-color-section .color-option');

            if (colorOptions.length >= 16 && borderColors.length >= 8 && iconColors.length >= 8) {
              log('✅ 颜色选择功能：预设颜色选项正确显示', 'success');

              // 测试点击颜色选项
              if (borderColors.length > 0) {
                $(borderColors[0]).trigger('click');
                log('✅ 颜色选择功能：边框颜色点击测试完成', 'success');
              }
            } else {
              log('❌ 颜色选择功能：颜色选项数量不正确', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试自定义颜色功能
      function testCustomColors() {
        log('🔄 测试自定义颜色功能...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('theme');
          window.WallpaperApp.show();

          setTimeout(() => {
            const customColorInputs = $('input[type="color"]');
            const customColorButtons = $('.apply-custom-color-btn');

            if (customColorInputs.length >= 2 && customColorButtons.length >= 2) {
              log('✅ 自定义颜色功能：颜色输入器和应用按钮正确显示', 'success');

              // 测试自定义颜色设置
              const borderColorInput = $('#customBorderColor');
              const borderColorButton = $('.apply-custom-color-btn[data-type="border"]');

              if (borderColorInput.length > 0 && borderColorButton.length > 0) {
                borderColorInput.val('#ff0000');
                borderColorButton.trigger('click');
                log('✅ 自定义颜色功能：边框颜色自定义测试完成', 'success');
              }
            } else {
              log('❌ 自定义颜色功能：界面元素缺失', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试滚动位置保持功能
      function testScrollPosition() {
        log('🔄 测试滚动位置保持功能...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('theme');
          window.WallpaperApp.show();

          setTimeout(() => {
            const $appBody = $('.wallpaper-app-body');
            if ($appBody.length > 0) {
              // 滚动到中间位置
              const scrollTarget = 200;
              $appBody.scrollTop(scrollTarget);

              setTimeout(() => {
                const beforeScroll = $appBody.scrollTop();
                log(`📍 滚动前位置: ${beforeScroll}px`, 'info');

                // 点击一个颜色选项
                const colorOption = $('.color-option').first();
                if (colorOption.length > 0) {
                  colorOption.trigger('click');

                  setTimeout(() => {
                    const afterScroll = $appBody.scrollTop();
                    log(`📍 滚动后位置: ${afterScroll}px`, 'info');

                    if (Math.abs(afterScroll - beforeScroll) < 50) {
                      log('✅ 滚动位置保持：位置保持正常', 'success');
                    } else {
                      log('❌ 滚动位置保持：位置发生跳转', 'error');
                    }
                  }, 300);
                }
              }, 100);
            } else {
              log('❌ 滚动位置保持：找不到应用主体元素', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 测试图标颜色修复功能
      function testIconColorFix() {
        log('🔄 测试图标颜色修复功能...', 'info');

        if (window.WallpaperApp && window.PhoneShell) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('theme');
          window.WallpaperApp.show();

          setTimeout(() => {
            // 测试设置一个自定义颜色
            const testColor = '#ff6b6b';
            window.WallpaperApp.applyColorConfig('icon', testColor);

            setTimeout(() => {
              // 检查CSS变量是否正确设置
              const $phone = $('#phone_interface');
              if ($phone.length > 0) {
                const computedStyle = window.getComputedStyle($phone[0]);
                const iconColor = computedStyle.getPropertyValue('--status-bar-icon-color').trim();
                const iconFilter = computedStyle.getPropertyValue('--status-bar-icon-filter').trim();

                log(`🎨 图标颜色设置: ${iconColor}`, 'info');
                log(`🔧 图标滤镜设置: ${iconFilter}`, 'info');

                if (iconColor === testColor && iconFilter && iconFilter !== 'brightness(0)') {
                  log('✅ 图标颜色修复：颜色和滤镜正确应用', 'success');
                } else {
                  log('❌ 图标颜色修复：颜色或滤镜设置有问题', 'error');
                }
              } else {
                log('❌ 图标颜色修复：找不到手机界面元素', 'error');
              }
            }, 200);
          }, 500);
        } else {
          log('❌ WallpaperApp或PhoneShell未加载', 'error');
        }
      }

      // 测试导入导出功能
      function testImportExport() {
        log('🔄 测试导入导出功能...', 'info');

        if (window.WallpaperApp) {
          window.WallpaperApp.setEditType('phone');
          window.WallpaperApp.switchMode('wallpaper');
          window.WallpaperApp.show();

          setTimeout(() => {
            // 检查导出按钮是否存在
            const exportBtn = $('.wallpaper-export-btn');
            const importBtn = $('.wallpaper-import-btn');

            if (exportBtn.length > 0 && importBtn.length > 0) {
              log('✅ 导入导出功能：按钮正确显示', 'success');

              // 模拟导出测试
              try {
                const testData = {
                  currentWallpaper: 'test.jpg',
                  history: ['test1.jpg', 'test2.jpg'],
                  qqBackgrounds: { home: '', homeBlur: 0, chats: {} },
                  themeConfig: { borderColor: '#ff0000', iconColor: '#00ff00' },
                };

                // 检查导出数据是否包含主题配置
                if (testData.themeConfig) {
                  log('✅ 导入导出功能：主题配置已集成到导出数据', 'success');
                } else {
                  log('❌ 导入导出功能：主题配置未集成', 'error');
                }
              } catch (error) {
                log('❌ 导入导出功能：导出测试失败', 'error');
              }
            } else {
              log('❌ 导入导出功能：按钮缺失', 'error');
            }
          }, 500);
        } else {
          log('❌ WallpaperApp未加载', 'error');
        }
      }

      // 运行全部测试
      function runAllTests() {
        clearResults();
        log('🚀 开始运行全部测试...', 'info');

        setTimeout(() => testPhoneWallpaperMode(), 100);
        setTimeout(() => testPhoneThemeMode(), 1000);
        setTimeout(() => testQQHomeMode(), 2000);
        setTimeout(() => testQQChatMode(), 3000);
        setTimeout(() => testColorSelection(), 4000);
        setTimeout(() => testCustomColors(), 5000);
        setTimeout(() => testScrollPosition(), 6000);
        setTimeout(() => testIconColorFix(), 7000);
        setTimeout(() => testImportExport(), 8000);

        setTimeout(() => {
          log('🎉 全部测试完成！', 'success');
        }, 9000);
      }

      // 页面加载完成后初始化
      $(document).ready(function () {
        log('页面加载完成，开始初始化...', 'info');

        // 检查必要的组件是否加载
        if (typeof window.PhoneShell === 'undefined') {
          log('❌ PhoneShell未加载', 'error');
          return;
        }

        if (typeof window.PhoneInterface === 'undefined') {
          log('❌ PhoneInterface未加载', 'error');
          return;
        }

        if (typeof window.WallpaperApp === 'undefined') {
          log('❌ WallpaperApp未加载', 'error');
          return;
        }

        // 初始化组件
        window.PhoneShell.init();
        window.PhoneInterface.initButtonOnly();
        window.WallpaperApp.init();

        log('✅ 所有组件初始化完成', 'success');

        // 创建测试手机界面
        const testContent = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>美化应用测试界面</h3>
                    <p>用于验证所有功能</p>
                </div>
            `;

        const phoneHTML = window.PhoneShell.createShellHTML(testContent, 'test_phone');
        $('#demoArea').html(phoneHTML);

        // 显示手机界面
        window.PhoneShell.show('test_phone');

        log('📱 测试手机界面已创建', 'success');
        log('✅ 测试环境初始化完成，可以开始测试', 'success');
      });
    </script>
  </body>
</html>
