<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SillyTavern ç»„ä»¶ä¿æŠ¤æµ‹è¯•</title>
    <script src="jquery-3.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button.danger {
            background: #dc3545;
        }
        
        .test-button.success {
            background: #28a745;
        }
        
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .component-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .component-item.protected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .component-item.mobile-plugin {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-info {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>SillyTavern ç»„ä»¶ä¿æŠ¤å…¨é¢æµ‹è¯•</h1>
        <p>è¿™ä¸ªæµ‹è¯•éªŒè¯æ‰‹æœºæ’ä»¶çš„æ–°ä¿æŠ¤æœºåˆ¶æ˜¯å¦èƒ½æ­£ç¡®ä¿æŠ¤æ‰€æœ‰ SillyTavern åŸç”Ÿç»„ä»¶ã€‚</p>
        
        <div>
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <button class="test-button" onclick="createTestComponents()">åˆ›å»ºæµ‹è¯•ç»„ä»¶</button>
            <button class="test-button danger" onclick="testMobilePluginCleanup()">æµ‹è¯•æ‰‹æœºæ’ä»¶æ¸…ç†</button>
            <button class="test-button success" onclick="checkAllComponents()">æ£€æŸ¥æ‰€æœ‰ç»„ä»¶çŠ¶æ€</button>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="component-grid" id="component-grid">
            <!-- ç»„ä»¶å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
        
        <div class="status-info" id="status-info">
            ç‚¹å‡»"åˆ›å»ºæµ‹è¯•ç»„ä»¶"å¼€å§‹æµ‹è¯•...
        </div>
    </div>
    
    <script>
        // æµ‹è¯•ç»„ä»¶å®šä¹‰
        const testComponents = {
            // SillyTavern åŸç”Ÿç»„ä»¶ï¼ˆåº”è¯¥è¢«ä¿æŠ¤ï¼‰
            protected: [
                { id: 'world_popup', name: 'World Popup', description: 'ä¸–ç•Œä¹¦å¼¹çª—' },
                { id: 'completion_prompt_manager_popup_edit', name: 'Prompt Manager', description: 'æç¤ºç®¡ç†å™¨ç¼–è¾‘å¼¹çª—' },
                { id: 'character_popup_edit', name: 'Character Popup', description: 'è§’è‰²ç¼–è¾‘å¼¹çª—' },
                { id: 'preset_popup_settings', name: 'Preset Popup', description: 'é¢„è®¾è®¾ç½®å¼¹çª—' },
                { id: 'WorldInfo', name: 'World Info', description: 'ä¸–ç•Œä¿¡æ¯ç•Œé¢' },
                { id: 'textgen_settings', name: 'TextGen Settings', description: 'æ–‡æœ¬ç”Ÿæˆè®¾ç½®' },
                { id: 'openai_settings', name: 'OpenAI Settings', description: 'OpenAIè®¾ç½®' }
            ],
            
            // æ‰‹æœºæ’ä»¶ç»„ä»¶ï¼ˆåº”è¯¥è¢«æ¸…ç†ï¼‰
            mobilePlugin: [
                { id: 'group_create_dialog', name: 'Group Create Dialog', description: 'QQç¾¤åˆ›å»ºå¼¹çª—' },
                { id: 'add_member_dialog', name: 'Add Member Dialog', description: 'æ·»åŠ æˆå‘˜å¼¹çª—' },
                { id: 'avatar_dialog', name: 'Avatar Dialog', description: 'å¤´åƒç¼–è¾‘å¼¹çª—' },
                { id: 'accept_task_dialog', name: 'Accept Task Dialog', description: 'ä»»åŠ¡æ¥å—å¼¹çª—' },
                { id: 'use_item_dialog', name: 'Use Item Dialog', description: 'ä½¿ç”¨ç‰©å“å¼¹çª—' },
                { id: 'mobile_test_popup', name: 'Mobile Test Popup', description: 'æ‰‹æœºæµ‹è¯•å¼¹çª—' },
                { id: 'qq_test_dialog', name: 'QQ Test Dialog', description: 'QQæµ‹è¯•å¯¹è¯æ¡†' }
            ]
        };
        
        function log(message) {
            const statusInfo = document.getElementById('status-info');
            const timestamp = new Date().toLocaleTimeString();
            statusInfo.innerHTML += `[${timestamp}] ${message}<br>`;
            statusInfo.scrollTop = statusInfo.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('status-info').innerHTML = '';
        }
        
        function createTestComponents() {
            log('ğŸ—ï¸ å¼€å§‹åˆ›å»ºæµ‹è¯•ç»„ä»¶...');
            
            const grid = document.getElementById('component-grid');
            grid.innerHTML = '';
            
            // åˆ›å»ºå—ä¿æŠ¤çš„ç»„ä»¶
            testComponents.protected.forEach(comp => {
                const div = document.createElement('div');
                div.id = comp.id;
                div.className = 'component-item protected';
                div.innerHTML = `
                    <h4>ğŸ›¡ï¸ ${comp.name}</h4>
                    <p>${comp.description}</p>
                    <small>ID: ${comp.id}</small>
                `;
                grid.appendChild(div);
                $('body').append(`<div id="${comp.id}_hidden" style="display:none;">${comp.name} éšè—å…ƒç´ </div>`);
            });
            
            // åˆ›å»ºæ‰‹æœºæ’ä»¶ç»„ä»¶
            testComponents.mobilePlugin.forEach(comp => {
                const div = document.createElement('div');
                div.id = comp.id;
                div.className = 'component-item mobile-plugin';
                div.innerHTML = `
                    <h4>ğŸ“± ${comp.name}</h4>
                    <p>${comp.description}</p>
                    <small>ID: ${comp.id}</small>
                `;
                grid.appendChild(div);
                $('body').append(`<div id="${comp.id}_hidden" style="display:none;">${comp.name} éšè—å…ƒç´ </div>`);
            });
            
            log(`âœ… å·²åˆ›å»º ${testComponents.protected.length} ä¸ªå—ä¿æŠ¤ç»„ä»¶å’Œ ${testComponents.mobilePlugin.length} ä¸ªæ‰‹æœºæ’ä»¶ç»„ä»¶`);
        }
        
        function testMobilePluginCleanup() {
            log('ğŸ§¹ æµ‹è¯•æ‰‹æœºæ’ä»¶æ¸…ç†åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿæ‰‹æœºæ’ä»¶çš„æ¸…ç†å‡½æ•°
            if (window.PhoneInterface && typeof window.PhoneInterface.removeMobilePluginDialogs === 'function') {
                window.PhoneInterface.removeMobilePluginDialogs();
            } else {
                log('âš ï¸ PhoneInterface.removeMobilePluginDialogs å‡½æ•°ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¸…ç†');
                
                // æ¨¡æ‹Ÿæ¸…ç†é€»è¾‘
                const mobilePluginSelectors = [
                    '#group_create_dialog',
                    '#add_member_dialog',
                    '#avatar_dialog',
                    '#accept_task_dialog',
                    '#use_item_dialog',
                    '[id^="mobile_"]',
                    '[id^="qq_"]'
                ];
                
                mobilePluginSelectors.forEach(selector => {
                    const elements = $(selector);
                    if (elements.length > 0) {
                        log(`  - åˆ é™¤ ${selector}: ${elements.length} ä¸ªå…ƒç´ `);
                        elements.remove();
                    }
                });
            }
            
            log('ğŸ” æ¸…ç†å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç»“æœ...');
            setTimeout(checkAllComponents, 500);
        }
        
        function checkAllComponents() {
            log('ğŸ“Š æ£€æŸ¥æ‰€æœ‰ç»„ä»¶çŠ¶æ€...');
            
            let protectedCount = 0;
            let removedCount = 0;
            
            // æ£€æŸ¥å—ä¿æŠ¤çš„ç»„ä»¶
            log('ğŸ›¡ï¸ å—ä¿æŠ¤ç»„ä»¶çŠ¶æ€:');
            testComponents.protected.forEach(comp => {
                const exists = $(`#${comp.id}`).length > 0;
                if (exists) {
                    log(`  âœ… ${comp.name} (${comp.id}) - å­˜åœ¨`);
                    protectedCount++;
                } else {
                    log(`  âŒ ${comp.name} (${comp.id}) - è¢«è¯¯åˆ ï¼`);
                }
            });
            
            // æ£€æŸ¥æ‰‹æœºæ’ä»¶ç»„ä»¶
            log('ğŸ“± æ‰‹æœºæ’ä»¶ç»„ä»¶çŠ¶æ€:');
            testComponents.mobilePlugin.forEach(comp => {
                const exists = $(`#${comp.id}`).length > 0;
                if (exists) {
                    log(`  âš ï¸ ${comp.name} (${comp.id}) - ä»ç„¶å­˜åœ¨ï¼ˆåº”è¯¥è¢«åˆ é™¤ï¼‰`);
                } else {
                    log(`  âœ… ${comp.name} (${comp.id}) - å·²æ­£ç¡®åˆ é™¤`);
                    removedCount++;
                }
            });
            
            // æ€»ç»“
            log('ğŸ“ˆ æµ‹è¯•ç»“æœæ€»ç»“:');
            log(`  - å—ä¿æŠ¤ç»„ä»¶: ${protectedCount}/${testComponents.protected.length} ä¸ªä¿æŠ¤æˆåŠŸ`);
            log(`  - æ‰‹æœºæ’ä»¶ç»„ä»¶: ${removedCount}/${testComponents.mobilePlugin.length} ä¸ªæ­£ç¡®åˆ é™¤`);
            
            if (protectedCount === testComponents.protected.length && removedCount === testComponents.mobilePlugin.length) {
                log('ğŸ‰ æµ‹è¯•å®Œå…¨é€šè¿‡ï¼æ‰€æœ‰ç»„ä»¶éƒ½å¾—åˆ°äº†æ­£ç¡®å¤„ç†ã€‚');
            } else {
                log('âš ï¸ æµ‹è¯•å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¿æŠ¤æœºåˆ¶ã€‚');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        $(document).ready(function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
            
            // æ£€æŸ¥æ˜¯å¦åŠ è½½äº†æ‰‹æœºç•Œé¢æ’ä»¶
            if (window.PhoneInterface) {
                log('âœ… PhoneInterface å·²åŠ è½½');
            } else {
                log('âš ï¸ PhoneInterface æœªåŠ è½½ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæµ‹è¯•');
            }
        });
    </script>
</body>
</html>
