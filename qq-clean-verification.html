<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQç•Œé¢æ¸…ç†éªŒè¯</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/phone-interface.css">
    <link rel="stylesheet" href="styles/qq-app.css">
    <link rel="stylesheet" href="styles/wallpaper-app.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .test-header {
            padding: 20px;
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
            text-align: center;
        }
        .test-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .test-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .test-btn.primary { background: #007bff; color: white; }
        .test-btn.success { background: #28a745; color: white; }
        .test-btn.warning { background: #ffc107; color: #212529; }
        .test-btn.danger { background: #dc3545; color: white; }
        .test-btn.info { background: #17a2b8; color: white; }
        .test-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .test-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .status-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-warning { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .verification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .verification-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .verification-item.clean {
            border-color: #28a745;
            background: #f8fff9;
        }
        .verification-item.dirty {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .verification-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .verification-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }
        .code-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§¹ QQç•Œé¢æ¸…ç†éªŒè¯</h1>
            <p>éªŒè¯WallpaperAppä¸­å·²å®Œå…¨ç§»é™¤å¥½å‹ç®¡ç†å’Œå¤´åƒç•Œé¢ç›¸å…³ä»£ç </p>
        </div>

        <div class="test-section">
            <h3>ğŸš€ 1. ç³»ç»Ÿåˆå§‹åŒ–</h3>
            <div class="test-buttons">
                <button class="test-btn primary" onclick="initializeSystem()">åˆå§‹åŒ–ç³»ç»Ÿ</button>
                <button class="test-btn info" onclick="checkWallpaperAppCode()">æ£€æŸ¥WallpaperAppä»£ç </button>
            </div>
            <div class="test-status" id="init-status">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” 2. ä»£ç æ¸…ç†éªŒè¯</h3>
            <div class="verification-grid">
                <div class="verification-item clean" id="friends-mgmt-check">
                    <h4>ğŸ‘¥ å¥½å‹ç®¡ç†</h4>
                    <p>æ£€æŸ¥æ˜¯å¦å·²ç§»é™¤ç›¸å…³ä»£ç </p>
                </div>
                <div class="verification-item clean" id="groups-mgmt-check">
                    <h4>ğŸ‘¥ ç¾¤èŠç®¡ç†</h4>
                    <p>æ£€æŸ¥æ˜¯å¦å·²ç§»é™¤ç›¸å…³ä»£ç </p>
                </div>
                <div class="verification-item clean" id="avatar-edit-check">
                    <h4>ğŸ‘¤ å¤´åƒç¼–è¾‘</h4>
                    <p>æ£€æŸ¥æ˜¯å¦å·²ç§»é™¤ç›¸å…³ä»£ç </p>
                </div>
                <div class="verification-item clean" id="protection-check">
                    <h4>ğŸ›¡ï¸ ä¿æŠ¤æœºåˆ¶</h4>
                    <p>æ£€æŸ¥æ˜¯å¦å·²ç§»é™¤ä¿æŠ¤ä»£ç </p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ 3. CSSè§„åˆ™æ£€æŸ¥</h3>
            <div class="test-buttons">
                <button class="test-btn info" onclick="listAllCSSRules()">åˆ—å‡ºæ‰€æœ‰CSSè§„åˆ™</button>
                <button class="test-btn warning" onclick="searchForTargetSelectors()">æœç´¢ç›®æ ‡é€‰æ‹©å™¨</button>
                <button class="test-btn success" onclick="verifyCleanState()">éªŒè¯æ¸…ç†çŠ¶æ€</button>
            </div>
            <div class="code-display" id="css-rules-display">CSSè§„åˆ™å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª 4. åŠŸèƒ½æµ‹è¯•</h3>
            <div class="test-buttons">
                <button class="test-btn primary" onclick="testQQHomeBackground()">æµ‹è¯•QQä¸»é¡µèƒŒæ™¯</button>
                <button class="test-btn success" onclick="testChatBackground()">æµ‹è¯•èŠå¤©èƒŒæ™¯</button>
                <button class="test-btn warning" onclick="testWhiteBackgroundMethod()">æµ‹è¯•ç™½è‰²èƒŒæ™¯æ–¹æ³•</button>
                <button class="test-btn danger" onclick="clearAllBackgrounds()">æ¸…é™¤æ‰€æœ‰èƒŒæ™¯</button>
            </div>
            <div class="test-status" id="function-test-status">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>âœ… 5. æœ€ç»ˆéªŒè¯</h3>
            <div class="test-buttons">
                <button class="test-btn success" onclick="runCompleteVerification()">è¿è¡Œå®Œæ•´éªŒè¯</button>
                <button class="test-btn info" onclick="showCleanupSummary()">æ˜¾ç¤ºæ¸…ç†æ‘˜è¦</button>
            </div>
            <div class="test-status" id="final-status">ç­‰å¾…éªŒè¯...</div>
        </div>
    </div>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="jquery-3.js"></script>
    <script src="apps/wallpaper-app.js"></script>
    <script src="apps/qq-data-manager.js"></script>
    <script src="apps/data-extractor.js"></script>
    <script src="apps/phone-interface.js"></script>
    <script src="apps/qq-app.js"></script>

    <script>
        // æµ‹è¯•è„šæœ¬
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                const timestamp = new Date().toLocaleTimeString();
                element.textContent = `[${timestamp}] ${message}`;
                element.className = `test-status status-${type}`;
            }
        }

        function updateVerificationItem(itemId, status, message = '') {
            const element = document.getElementById(itemId);
            if (element) {
                element.className = `verification-item ${status}`;
                if (message) {
                    const p = element.querySelector('p');
                    if (p) p.textContent = message;
                }
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
                
                if (window.WallpaperApp) {
                    window.WallpaperApp.init();
                    updateStatus('init-status', 'WallpaperAppå·²åˆå§‹åŒ–', 'success');
                } else {
                    updateStatus('init-status', 'WallpaperAppæœªåŠ è½½', 'error');
                    return;
                }
                
                if (window.PhoneInterface) {
                    window.PhoneInterface.init();
                }
                
                updateStatus('init-status', 'æ‰€æœ‰åº”ç”¨å·²åˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('init-status', 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥WallpaperAppä»£ç 
        function checkWallpaperAppCode() {
            try {
                if (window.WallpaperApp) {
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç›¸å…³æ–¹æ³•
                    const hasProtectMethod = typeof window.WallpaperApp.protectIndependentInterfaces === 'function';
                    const hasEnsureWhiteMethod = typeof window.WallpaperApp.ensureWhiteBackgrounds === 'function';
                    const hasRemoveWhiteMethod = typeof window.WallpaperApp.removeWhiteBackgrounds === 'function';
                    
                    updateStatus('init-status', 
                        `ä»£ç æ£€æŸ¥: ä¿æŠ¤æ–¹æ³•${hasProtectMethod ? 'å­˜åœ¨' : 'å·²ç§»é™¤'}, ` +
                        `ç™½è‰²èƒŒæ™¯æ–¹æ³•${hasEnsureWhiteMethod ? 'å­˜åœ¨' : 'å·²ç§»é™¤'}, ` +
                        `ç§»é™¤ç™½è‰²æ–¹æ³•${hasRemoveWhiteMethod ? 'å­˜åœ¨' : 'å·²ç§»é™¤'}`, 
                        'info');
                } else {
                    updateStatus('init-status', 'WallpaperAppæœªåŠ è½½', 'error');
                }
            } catch (error) {
                updateStatus('init-status', 'æ£€æŸ¥ä»£ç å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ—å‡ºæ‰€æœ‰CSSè§„åˆ™
        function listAllCSSRules() {
            try {
                if (window.WallpaperApp && window.WallpaperApp.styleSheet) {
                    const rules = Array.from(window.WallpaperApp.styleSheet.cssRules);
                    const rulesText = rules.map((rule, index) => `${index}: ${rule.cssText}`).join('\n');
                    document.getElementById('css-rules-display').textContent = rulesText || 'æš‚æ— CSSè§„åˆ™';
                    
                    updateStatus('function-test-status', `å·²åˆ—å‡º${rules.length}ä¸ªCSSè§„åˆ™`, 'info');
                } else {
                    document.getElementById('css-rules-display').textContent = 'æ ·å¼è¡¨æœªåˆ›å»º';
                    updateStatus('function-test-status', 'æ ·å¼è¡¨æœªåˆ›å»º', 'error');
                }
            } catch (error) {
                document.getElementById('css-rules-display').textContent = 'è·å–CSSè§„åˆ™å¤±è´¥: ' + error.message;
                updateStatus('function-test-status', 'åˆ—å‡ºCSSè§„åˆ™å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æœç´¢ç›®æ ‡é€‰æ‹©å™¨
        function searchForTargetSelectors() {
            try {
                const targetSelectors = [
                    'friends-management-page',
                    'friend-manager', 
                    'groups-management-page',
                    'avatar_dialog',
                    'user_avatar_dialog'
                ];
                
                if (window.WallpaperApp && window.WallpaperApp.styleSheet) {
                    const rules = Array.from(window.WallpaperApp.styleSheet.cssRules);
                    const foundSelectors = [];
                    
                    rules.forEach((rule, index) => {
                        targetSelectors.forEach(selector => {
                            if (rule.cssText.includes(selector)) {
                                foundSelectors.push(`è§„åˆ™${index}: åŒ…å« ${selector}`);
                            }
                        });
                    });
                    
                    if (foundSelectors.length === 0) {
                        document.getElementById('css-rules-display').textContent = 'âœ… æœªæ‰¾åˆ°ä»»ä½•ç›®æ ‡é€‰æ‹©å™¨ï¼Œæ¸…ç†æˆåŠŸï¼';
                        updateStatus('function-test-status', 'æœç´¢å®Œæˆï¼šæœªæ‰¾åˆ°ç›®æ ‡é€‰æ‹©å™¨', 'success');
                        
                        // æ›´æ–°éªŒè¯çŠ¶æ€
                        updateVerificationItem('friends-mgmt-check', 'clean', 'âœ… å·²å®Œå…¨ç§»é™¤');
                        updateVerificationItem('groups-mgmt-check', 'clean', 'âœ… å·²å®Œå…¨ç§»é™¤');
                        updateVerificationItem('avatar-edit-check', 'clean', 'âœ… å·²å®Œå…¨ç§»é™¤');
                        updateVerificationItem('protection-check', 'clean', 'âœ… å·²å®Œå…¨ç§»é™¤');
                    } else {
                        document.getElementById('css-rules-display').textContent = 'âŒ æ‰¾åˆ°ç›®æ ‡é€‰æ‹©å™¨:\n' + foundSelectors.join('\n');
                        updateStatus('function-test-status', `æœç´¢å®Œæˆï¼šæ‰¾åˆ°${foundSelectors.length}ä¸ªç›®æ ‡é€‰æ‹©å™¨`, 'error');
                        
                        // æ›´æ–°éªŒè¯çŠ¶æ€
                        updateVerificationItem('friends-mgmt-check', 'dirty', 'âŒ ä»æœ‰ç›¸å…³ä»£ç ');
                        updateVerificationItem('groups-mgmt-check', 'dirty', 'âŒ ä»æœ‰ç›¸å…³ä»£ç ');
                        updateVerificationItem('avatar-edit-check', 'dirty', 'âŒ ä»æœ‰ç›¸å…³ä»£ç ');
                        updateVerificationItem('protection-check', 'dirty', 'âŒ ä»æœ‰ç›¸å…³ä»£ç ');
                    }
                } else {
                    document.getElementById('css-rules-display').textContent = 'æ ·å¼è¡¨æœªåˆ›å»ºï¼Œæ— æ³•æœç´¢';
                    updateStatus('function-test-status', 'æ ·å¼è¡¨æœªåˆ›å»º', 'error');
                }
            } catch (error) {
                document.getElementById('css-rules-display').textContent = 'æœç´¢å¤±è´¥: ' + error.message;
                updateStatus('function-test-status', 'æœç´¢ç›®æ ‡é€‰æ‹©å™¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯æ¸…ç†çŠ¶æ€
        function verifyCleanState() {
            try {
                if (window.WallpaperApp && window.WallpaperApp.cssRuleMap) {
                    const ruleIds = Array.from(window.WallpaperApp.cssRuleMap.keys());
                    const suspiciousRules = ruleIds.filter(id => 
                        id.includes('white') || 
                        id.includes('protection') || 
                        id.includes('interface')
                    );
                    
                    if (suspiciousRules.length === 0) {
                        updateStatus('function-test-status', 'âœ… æ¸…ç†çŠ¶æ€éªŒè¯é€šè¿‡ï¼Œæ— å¯ç–‘è§„åˆ™', 'success');
                    } else {
                        updateStatus('function-test-status', `âš ï¸ å‘ç°å¯ç–‘è§„åˆ™: ${suspiciousRules.join(', ')}`, 'warning');
                    }
                    
                    document.getElementById('css-rules-display').textContent = 
                        `å½“å‰CSSè§„åˆ™ID: ${ruleIds.join(', ') || 'æ— è§„åˆ™'}\n` +
                        `å¯ç–‘è§„åˆ™: ${suspiciousRules.join(', ') || 'æ— '}`;
                } else {
                    updateStatus('function-test-status', 'CSSè§„åˆ™æ˜ å°„æœªåˆ›å»º', 'error');
                }
            } catch (error) {
                updateStatus('function-test-status', 'éªŒè¯æ¸…ç†çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•QQä¸»é¡µèƒŒæ™¯
        function testQQHomeBackground() {
            try {
                const testUrl = 'https://files.catbox.moe/test-qq-home.jpg';
                if (window.WallpaperApp) {
                    window.WallpaperApp.updateQQHomeBackground(testUrl, 3);
                    updateStatus('function-test-status', 'QQä¸»é¡µèƒŒæ™¯æµ‹è¯•å®Œæˆ: ' + testUrl, 'success');
                } else {
                    updateStatus('function-test-status', 'WallpaperAppæœªåŠ è½½', 'error');
                }
            } catch (error) {
                updateStatus('function-test-status', 'æµ‹è¯•QQä¸»é¡µèƒŒæ™¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•èŠå¤©èƒŒæ™¯
        function testChatBackground() {
            try {
                const testUrl = 'https://files.catbox.moe/test-chat.jpg';
                const chatId = 'test123';
                if (window.WallpaperApp) {
                    window.WallpaperApp.updateQQChatBackground(chatId, testUrl, 2);
                    updateStatus('function-test-status', `èŠå¤©èƒŒæ™¯æµ‹è¯•å®Œæˆ: ${testUrl} (èŠå¤©ID: ${chatId})`, 'success');
                } else {
                    updateStatus('function-test-status', 'WallpaperAppæœªåŠ è½½', 'error');
                }
            } catch (error) {
                updateStatus('function-test-status', 'æµ‹è¯•èŠå¤©èƒŒæ™¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•ç™½è‰²èƒŒæ™¯æ–¹æ³•
        function testWhiteBackgroundMethod() {
            try {
                if (window.WallpaperApp && typeof window.WallpaperApp.ensureWhiteBackgrounds === 'function') {
                    window.WallpaperApp.ensureWhiteBackgrounds();
                    updateStatus('function-test-status', 'ç™½è‰²èƒŒæ™¯æ–¹æ³•å·²è°ƒç”¨ï¼ˆåº”è¯¥å·²æ¸…ç©ºï¼‰', 'warning');
                } else {
                    updateStatus('function-test-status', 'ç™½è‰²èƒŒæ™¯æ–¹æ³•ä¸å­˜åœ¨', 'info');
                }
            } catch (error) {
                updateStatus('function-test-status', 'æµ‹è¯•ç™½è‰²èƒŒæ™¯æ–¹æ³•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰èƒŒæ™¯
        function clearAllBackgrounds() {
            try {
                if (window.WallpaperApp && window.WallpaperApp.cssRuleMap) {
                    const ruleIds = Array.from(window.WallpaperApp.cssRuleMap.keys());
                    ruleIds.forEach(id => window.WallpaperApp.removeCSSRule(id));
                    updateStatus('function-test-status', `å·²æ¸…é™¤${ruleIds.length}ä¸ªCSSè§„åˆ™`, 'success');
                } else {
                    updateStatus('function-test-status', 'CSSè§„åˆ™æ˜ å°„æœªåˆ›å»º', 'error');
                }
            } catch (error) {
                updateStatus('function-test-status', 'æ¸…é™¤èƒŒæ™¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´éªŒè¯
        function runCompleteVerification() {
            try {
                updateStatus('final-status', 'å¼€å§‹è¿è¡Œå®Œæ•´éªŒè¯...', 'info');
                
                // 1. æœç´¢ç›®æ ‡é€‰æ‹©å™¨
                searchForTargetSelectors();
                
                setTimeout(() => {
                    // 2. éªŒè¯æ¸…ç†çŠ¶æ€
                    verifyCleanState();
                    
                    setTimeout(() => {
                        // 3. æµ‹è¯•åŠŸèƒ½
                        testQQHomeBackground();
                        
                        setTimeout(() => {
                            testChatBackground();
                            
                            setTimeout(() => {
                                updateStatus('final-status', 'å®Œæ•´éªŒè¯å®Œæˆï¼è¯·æŸ¥çœ‹å„é¡¹æ£€æŸ¥ç»“æœ', 'success');
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
                
            } catch (error) {
                updateStatus('final-status', 'å®Œæ•´éªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¸…ç†æ‘˜è¦
        function showCleanupSummary() {
            const summary = `
ğŸ§¹ QQç•Œé¢æ¸…ç†æ‘˜è¦:

âœ… å·²ç§»é™¤çš„é€‰æ‹©å™¨:
- .friends-management-page (å¥½å‹ç®¡ç†é¡µé¢)
- .friend-manager (å¥½å‹ç®¡ç†å™¨)
- .groups-management-page (ç¾¤èŠç®¡ç†é¡µé¢)
- #avatar_dialog (å¤´åƒå¯¹è¯æ¡†)
- #user_avatar_dialog (ç”¨æˆ·å¤´åƒå¯¹è¯æ¡†)

âœ… å·²ç§»é™¤çš„æ–¹æ³•:
- protectIndependentInterfaces() (ä¿æŠ¤ç‹¬ç«‹ç•Œé¢)

âœ… å·²æ¸…ç©ºçš„æ–¹æ³•:
- ensureWhiteBackgrounds() (ç¡®ä¿ç™½è‰²èƒŒæ™¯)

âœ… ä¿ç•™çš„åŠŸèƒ½:
- QQä¸»é¡µèƒŒæ™¯è®¾ç½® (åªå½±å“QQä¸»é¡µ)
- èŠå¤©èƒŒæ™¯è®¾ç½® (æ¯ä¸ªèŠå¤©ç‹¬ç«‹)
- æ‰‹æœºå£çº¸è®¾ç½® (åªå½±å“æ‰‹æœºä¸»å±)

ç°åœ¨å¥½å‹ç®¡ç†å’Œå¤´åƒç•Œé¢å®Œå…¨æ¢å¤åˆ°åŸå§‹çŠ¶æ€ï¼
            `;
            
            document.getElementById('css-rules-display').textContent = summary;
            updateStatus('final-status', 'æ¸…ç†æ‘˜è¦å·²æ˜¾ç¤º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        $(document).ready(function() {
            console.log('ğŸš€ QQç•Œé¢æ¸…ç†éªŒè¯é¡µé¢å·²åŠ è½½');
            setTimeout(initializeSystem, 1000);
        });
    </script>
</body>
</html>
